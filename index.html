<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œì•„ì„±ì¥ AI ì±—ë´‡</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; display: flex; justify-content: center; align-items: center;
        }
        .chatbot-container {
            width: 90%; max-width: 500px; height: 90vh; max-height: 700px;
            background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .chat-header {
            background: linear-gradient(135deg, #00B050 0%, #00d561 100%);
            color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chat-header h1 { font-size: 20px; margin-bottom: 5px; }
        .chat-header p { font-size: 12px; opacity: 0.9; }
        .ai-badge { 
            background: rgba(255,255,255,0.2); 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 11px; 
            display: inline-block; 
            margin-top: 5px;
        }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .user-message { align-items: flex-end; }
        .bot-message { align-items: flex-start; }
        .message-bubble {
            max-width: 80%; padding: 12px 16px; border-radius: 18px;
            word-wrap: break-word; line-height: 1.5; position: relative;
        }
        .user-message .message-bubble {
            background: #007bff; color: white; border-bottom-right-radius: 4px;
        }
        .bot-message .message-bubble {
            background: white; color: #333; border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .cache-badge {
            position: absolute; top: -8px; right: -8px;
            background: #28a745; color: white;
            font-size: 9px; padding: 2px 6px; border-radius: 8px;
        }
        .ai-badge-msg {
            position: absolute; top: -8px; right: -8px;
            background: #4285f4; color: white;
            font-size: 9px; padding: 2px 6px; border-radius: 8px;
        }
        .video-button {
            display: inline-block; margin-top: 10px; padding: 10px 20px;
            background: #FF0000; color: white; text-decoration: none;
            border-radius: 20px; font-size: 14px; transition: background 0.3s;
        }
        .video-button:hover { background: #cc0000; }
        .chat-input-container {
            padding: 15px; background: white; border-top: 1px solid #e0e0e0;
            display: flex; gap: 10px;
        }
        .chat-input {
            flex: 1; padding: 12px 16px; border: 2px solid #e0e0e0;
            border-radius: 25px; font-size: 14px; outline: none; transition: border 0.3s;
        }
        .chat-input:focus { border-color: #00B050; }
        .send-button {
            padding: 12px 24px; background: #00B050; color: white; border: none;
            border-radius: 25px; font-size: 14px; cursor: pointer; transition: background 0.3s;
        }
        .send-button:hover { background: #009040; }
        .send-button:active { transform: scale(0.95); }
        .loading { display: none; text-align: center; padding: 10px; color: #666; font-size: 13px; }
        .loading.show { display: block; }
        .welcome-message { text-align: center; padding: 40px 20px; color: #666; }
        .welcome-message h2 { color: #00B050; margin-bottom: 10px; }
        .example-questions { margin-top: 20px; text-align: left; }
        .example-questions h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .example-question {
            background: white; padding: 10px 15px; margin: 8px 0; border-radius: 10px;
            cursor: pointer; font-size: 13px; color: #333; transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .example-question:hover { background: #f0f0f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
<div class="chatbot-container">
    <div class="chat-header">
        <h1>ğŸ¥ ì†Œì•„ì„±ì¥ AI ì±—ë´‡</h1>
        <p>ì„±ì¥í˜¸ë¥´ëª¬ãƒ»ì„±ì¡°ìˆ™ì¦ãƒ»ì†Œì•„ë¹„ë§Œ ì „ë¬¸</p>
        <div class="ai-badge">ğŸ¤– Powered by Google Gemini AI</div>
    </div>
    <div class="chat-messages" id="messages">
        <div class="welcome-message">
            <h2>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
            <p>AIê°€ ìì—°ìŠ¤ëŸ½ê²Œ ì´í•´í•˜ê³ <br>ì •í™•í•˜ê²Œ ë‹µë³€ë“œë¦½ë‹ˆë‹¤!</p>
            <div class="example-questions">
                <h3>ğŸ’¡ ì´ëŸ° ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”:</h3>
                <div class="example-question" onclick="sendExampleQuestion('ì„±ì¥í˜¸ë¥´ëª¬ì€ ì–¸ì œ ë‚˜ì˜¤ë‚˜ìš”?')">
                    ì„±ì¥í˜¸ë¥´ëª¬ì€ ì–¸ì œ ë‚˜ì˜¤ë‚˜ìš”?
                </div>
                <div class="example-question" onclick="sendExampleQuestion('ì•„ì´ê°€ 8ì„¼í‹°ë¯¸í„°ë‚˜ ìëì–´ìš”')">
                    ì•„ì´ê°€ 8ì„¼í‹°ë¯¸í„°ë‚˜ ìëì–´ìš”
                </div>
                <div class="example-question" onclick="sendExampleQuestion('ê°€ìŠ´ì— ë©ìš¸ì´ ìƒê²¼ì–´ìš”')">
                    ê°€ìŠ´ì— ë©ìš¸ì´ ìƒê²¼ì–´ìš”
                </div>
                <div class="example-question" onclick="sendExampleQuestion('ë¹„íƒ€ë¯¼ Dê°€ í•„ìš”í•œê°€ìš”?')">
                    ë¹„íƒ€ë¯¼ Dê°€ í•„ìš”í•œê°€ìš”?
                </div>
            </div>
        </div>
    </div>
    <div class="loading" id="loading">ğŸ¤– AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
    <div class="chat-input-container">
        <input type="text" class="chat-input" id="userInput" placeholder="ê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="send-button" onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>

<script>
// âš ï¸ ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”!
const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE';

let allRecords = [];
let isFirstMessage = true;
let requestCount = 0;
const MAX_REQUESTS_PER_MINUTE = 15;

window.addEventListener('load', async function() {
    console.log('ë°ì´í„° ë¡œë”© ì‹œì‘...');
    try {
        const response = await fetch('chatbot_data.json');
        if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        allRecords = await response.json();
        
        // ì„±ì¸ ë¹„ë§Œ ìˆ˜ìˆ  ê´€ë ¨ ì œê±°
        allRecords = allRecords.filter(r => 
            !r.ì§ˆë¬¸.includes('ë¹„ë§Œ ìˆ˜ìˆ ') && 
            !r.ë‹µë³€.includes('ìœ„ë¥¼ ì ˆì œ')
        );
        
        console.log(`âœ“ ${allRecords.length}ê°œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
    } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
});

function getCachedAnswer(question) {
    const cache = JSON.parse(localStorage.getItem('chatCache') || '{}');
    const normalized = question.toLowerCase().trim();
    return cache[normalized] || null;
}

function setCachedAnswer(question, answer) {
    const cache = JSON.parse(localStorage.getItem('chatCache') || '{}');
    const normalized = question.toLowerCase().trim();
    cache[normalized] = answer;
    const keys = Object.keys(cache);
    if (keys.length > 100) {
        delete cache[keys[0]];
    }
    localStorage.setItem('chatCache', JSON.stringify(cache));
}

function sendExampleQuestion(question) {
    document.getElementById('userInput').value = question;
    sendMessage();
}

async function sendMessage() {
    const input = document.getElementById('userInput');
    const question = input.value.trim();
    if (!question) return;
    
    if (allRecords.length === 0) {
        alert('ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (isFirstMessage) {
        const welcome = document.querySelector('.welcome-message');
        if (welcome) welcome.remove();
        isFirstMessage = false;
    }
    
    addMessage(question, 'user');
    input.value = '';
    document.getElementById('loading').classList.add('show');
    
    // 1ë‹¨ê³„: ìºì‹œ í™•ì¸
    const cached = getCachedAnswer(question);
    if (cached) {
        console.log('âœ“ ìºì‹œì—ì„œ ë‹µë³€ ë¡œë“œ');
        document.getElementById('loading').classList.remove('show');
        addMessage(cached.answer, 'bot', cached.videoLink, 'cache');
        return;
    }
    
    // 2ë‹¨ê³„: Gemini AI í˜¸ì¶œ
    try {
        const answer = await callGeminiAI(question);
        document.getElementById('loading').classList.remove('show');
        
        if (answer) {
            addMessage(answer.text, 'bot', answer.videoLink, 'ai');
            setCachedAnswer(question, { answer: answer.text, videoLink: answer.videoLink });
        } else {
            // 3ë‹¨ê³„: Fallback
            const fallbackAnswer = findAnswerFallback(question);
            if (fallbackAnswer) {
                addMessage(fallbackAnswer.answer, 'bot', fallbackAnswer.videoLink);
            } else {
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì§ˆë¬¸í•´ì£¼ì‹œê±°ë‚˜, ë” êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.', 'bot');
            }
        }
    } catch (error) {
        console.error('ì—ëŸ¬:', error);
        document.getElementById('loading').classList.remove('show');
        
        const fallbackAnswer = findAnswerFallback(question);
        if (fallbackAnswer) {
            addMessage(fallbackAnswer.answer, 'bot', fallbackAnswer.videoLink);
        } else {
            addMessage('ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'bot');
        }
    }
}

async function callGeminiAI(question) {
    // RPM ì œí•œ ì²´í¬
    requestCount++;
    setTimeout(() => requestCount--, 60000);
    
    if (requestCount > MAX_REQUESTS_PER_MINUTE) {
        console.log('RPM ì œí•œ ì´ˆê³¼, Fallback ì‚¬ìš©');
        return null;
    }
    
    if (!GEMINI_API_KEY || GEMINI_API_KEY === 'AIzaSyD1g7RYxZCCwMiKQuDBEoAdeSMXZ-RU-Nc') {
        console.error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        return null;
    }
    
    // ìŠ¤ë§ˆíŠ¸ í•„í„°ë§: ê´€ë ¨ Q&Aë§Œ ì„ íƒ
    const relevantQA = filterRelevantQA(question);
    
    if (relevantQA.length === 0) {
        console.log('ê´€ë ¨ Q&A ì—†ìŒ, Fallback ì‚¬ìš©');
        return null;
    }
    
    // Q&A ë°ì´í„°ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ ì œê³µ
    const context = relevantQA.map(r => 
        `ì§ˆë¬¸: ${r.ì§ˆë¬¸}\në‹µë³€: ${r.ë‹µë³€}`
    ).join('\n\n---\n\n');
    
    const prompt = `ë‹¹ì‹ ì€ ì†Œì•„ ì„±ì¥ ì „ë¬¸ ì˜ë£Œ AI ì±—ë´‡ì…ë‹ˆë‹¤.

ì•„ë˜ Q&A ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ê°€ì¥ ì í•©í•œ ë‹µë³€ì„ ì°¾ì•„ ì œê³µí•˜ì„¸ìš”.

# ê·œì¹™
1. ë°˜ë“œì‹œ ì•„ë˜ Q&A ë°ì´í„°ë² ì´ìŠ¤ì˜ ë‹µë³€ë§Œ ì‚¬ìš©í•˜ì„¸ìš”
2. ì‚¬ìš©ì ì§ˆë¬¸ê³¼ ê°€ì¥ ìœ ì‚¬í•œ ì§ˆë¬¸ì„ ì°¾ìœ¼ì„¸ìš”
3. ê·¸ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ê·¸ëŒ€ë¡œ ì œê³µí•˜ì„¸ìš”
4. ë‹µë³€ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì¶”ê°€ ì„¤ëª…í•˜ì§€ ë§ˆì„¸ìš”
5. ë§Œì•½ ê´€ë ¨ ë‹µë³€ì´ ì—†ë‹¤ë©´ "ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¼ê³ ë§Œ ë‹µí•˜ì„¸ìš”

# Q&A ë°ì´í„°ë² ì´ìŠ¤
${context}

# ì‚¬ìš©ì ì§ˆë¬¸
${question}

# ë‹µë³€`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.1,  // ë” ì •í™•í•˜ê²Œ
                    maxOutputTokens: 1000
                }
            })
        });
        
        if (!response.ok) {
            console.error('Gemini API ì˜¤ë¥˜:', response.status);
            return null;
        }
        
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!text || text.includes('ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
            return null;
        }
        
        // ì˜ìƒ ë§í¬ ì°¾ê¸°
        let videoLink = null;
        for (const record of relevantQA) {
            if (text.includes(record.ë‹µë³€.substring(0, 50))) {
                videoLink = record.ì˜ìƒë§í¬;
                break;
            }
        }
        
        return { text, videoLink };
    } catch (error) {
        console.error('Gemini API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        return null;
    }
}

function filterRelevantQA(question) {
    const lowerQuestion = question.toLowerCase();
    
    // ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œ
    const categories = {
        'ì„±ì¥í˜¸ë¥´ëª¬': ['ì„±ì¥í˜¸ë¥´ëª¬', 'í˜¸ë¥´ëª¬', 'ì£¼ì‚¬', 'ì¹˜ë£Œ'],
        'ì„±ì¡°ìˆ™ì¦': ['ì„±ì¡°ìˆ™ì¦', 'ê°€ìŠ´', 'ë©ìš¸', 'ì‚¬ì¶˜ê¸°', '2ì°¨ì„±ì§•', 'ìœ ë°©'],
        'ì†Œì•„ë¹„ë§Œ': ['ë¹„ë§Œ', 'ì‚´', 'ì²´ì¤‘', 'ëš±ëš±', 'ë‹¤ì´ì–´íŠ¸'],
        'ì˜ì–‘': ['ë¹„íƒ€ë¯¼', 'ì˜ì–‘', 'ì¹¼ìŠ˜', 'ì•„ì—°', 'ì² ë¶„', 'ë‹¨ë°±ì§ˆ', 'ì˜ì–‘ì œ'],
        'ìˆ˜ë©´': ['ìˆ˜ë©´', 'ì ', 'ìì•¼', 'ëŠ¦ê²Œ'],
        'ìš´ë™': ['ìš´ë™', 'ìŠ¤íŠ¸ë ˆì¹­'],
        'í‚¤ì„±ì¥': ['í‚¤', 'í¬', 'ì‘', 'ì €ì‹ ì¥', 'ì„¼í‹°', 'cm', 'ì„±ì¥', 'ìë¼'],
        'ê²€ì‚¬': ['ê²€ì‚¬', 'ë³‘ì›', 'ë¹„ìš©', 'ê³¨ì—°ë ¹', 'ë¼ˆë‚˜ì´'],
    };
    
    // ì–´ë–¤ ì¹´í…Œê³ ë¦¬ì— ì†í•˜ëŠ”ì§€ íŒŒì•…
    let matchedCategories = [];
    for (const [category, keywords] of Object.entries(categories)) {
        for (const keyword of keywords) {
            if (lowerQuestion.includes(keyword)) {
                matchedCategories.push(category);
                break;
            }
        }
    }
    
    // ê´€ë ¨ Q&A í•„í„°ë§
    let relevantQA = [];
    
    if (matchedCategories.length > 0) {
        // ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” Q&Aë§Œ ì„ íƒ
        for (const record of allRecords) {
            const recordText = (record.ì§ˆë¬¸ + ' ' + record.í‚¤ì›Œë“œ).toLowerCase();
            for (const category of matchedCategories) {
                const keywords = categories[category];
                for (const keyword of keywords) {
                    if (recordText.includes(keyword)) {
                        relevantQA.push(record);
                        break;
                    }
                }
                if (relevantQA.includes(record)) break;
            }
            
            // ìµœëŒ€ 30ê°œê¹Œì§€ë§Œ
            if (relevantQA.length >= 30) break;
        }
    } else {
        // ì¹´í…Œê³ ë¦¬ ë§¤ì¹­ ì•ˆë˜ë©´ ì „ì²´ì—ì„œ í‚¤ì›Œë“œ ë§¤ì¹­
        for (const record of allRecords) {
            const recordText = (record.ì§ˆë¬¸ + ' ' + record.í‚¤ì›Œë“œ).toLowerCase();
            // ì§ˆë¬¸ì˜ ë‹¨ì–´ë“¤ê³¼ ë§¤ì¹­
            const words = lowerQuestion.split(' ').filter(w => w.length > 1);
            let score = 0;
            for (const word of words) {
                if (recordText.includes(word)) {
                    score++;
                }
            }
            if (score > 0) {
                relevantQA.push({ ...record, score });
            }
        }
        
        // ì ìˆ˜ìˆœ ì •ë ¬ í›„ ìƒìœ„ 30ê°œ
        relevantQA.sort((a, b) => b.score - a.score);
        relevantQA = relevantQA.slice(0, 30);
    }
    
    console.log(`âœ“ ê´€ë ¨ Q&A ${relevantQA.length}ê°œ í•„í„°ë§`);
    return relevantQA;
}

function findAnswerFallback(question) {
    if (allRecords.length === 0) return null;
    
    const lowerQuestion = question.toLowerCase();
    let bestMatch = null;
    let bestScore = 0;
    
    for (const record of allRecords) {
        const dbQuestion = (record.ì§ˆë¬¸ || '').toLowerCase();
        const keywords = (record.í‚¤ì›Œë“œ || '').toLowerCase();
        let score = 0;
        
        if (dbQuestion.includes(lowerQuestion) || lowerQuestion.includes(dbQuestion)) {
            score = 100;
        } else {
            const keywordList = keywords.split(',').map(k => k.trim());
            for (const keyword of keywordList) {
                if (keyword && lowerQuestion.includes(keyword)) {
                    score += 30;
                }
            }
        }
        
        if (score > bestScore) {
            bestScore = score;
            bestMatch = {
                answer: record.ë‹µë³€,
                videoLink: record.ì˜ìƒë§í¬
            };
        }
    }
    
    return bestScore >= 30 ? bestMatch : null;
}

function addMessage(text, type, videoLink = null, source = null) {
    const messages = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = text;
    
    if (source === 'cache' && type === 'bot') {
        const badge = document.createElement('div');
        badge.className = 'cache-badge';
        badge.textContent = 'ìºì‹œ';
        bubble.appendChild(badge);
    } else if (source === 'ai' && type === 'bot') {
        const badge = document.createElement('div');
        badge.className = 'ai-badge-msg';
        badge.textContent = 'AI';
        bubble.appendChild(badge);
    }
    
    messageDiv.appendChild(bubble);
    
    if (videoLink && type === 'bot' && videoLink !== 'nan') {
        const videoBtn = document.createElement('a');
        videoBtn.className = 'video-button';
        videoBtn.href = videoLink;
        videoBtn.target = '_blank';
        videoBtn.innerHTML = 'ğŸ“º ì˜ìƒìœ¼ë¡œ ë³´ê¸°';
        bubble.appendChild(document.createElement('br'));
        bubble.appendChild(videoBtn);
    }
    
    messages.appendChild(messageDiv);
    messages.scrollTop = messages.scrollHeight;
}
</script>
</body>
</html>
